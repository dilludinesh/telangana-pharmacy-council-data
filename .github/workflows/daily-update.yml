name: Data Fetch

on:
  schedule:
    # Run weekdays only during business hours (like a real office worker)
    # Randomized times between 11 AM - 3 PM IST (5:30 AM - 9:30 AM UTC)
    - cron: '45 5 * * 1'   # Monday 11:15 AM IST (5:45 AM UTC)
    - cron: '20 7 * * 2'   # Tuesday 12:50 PM IST (7:20 AM UTC)
    - cron: '55 8 * * 3'   # Wednesday 2:25 PM IST (8:55 AM UTC)
    - cron: '10 6 * * 4'   # Thursday 11:40 AM IST (6:10 AM UTC)
    - cron: '30 9 * * 5'   # Friday 3:00 PM IST (9:30 AM UTC)
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install supabase
    
    - name: Create data directory
      run: |
        mkdir -p data/backups
    
    - name: Check if already updated today
      id: check_update
      run: |
        # Check if we already updated today by looking at recent commits
        TODAY=$(date -u +%Y-%m-%d)
        RECENT_COMMIT=$(git log --oneline --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --grep="ü§ñ Daily data update" | head -1)
        
        if [ -n "$RECENT_COMMIT" ]; then
          echo "already_updated=true" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Already updated today: $RECENT_COMMIT"
        else
          echo "already_updated=false" >> $GITHUB_OUTPUT
          echo "‚úÖ No update today yet, proceeding..."
        fi

    - name: Run daily update
      if: steps.check_update.outputs.already_updated == 'false'
      id: update
      run: |
        echo "üîÑ Starting daily TGPC data update during business hours..."
        python -c "
        from tgpc.automation.daily_updater import run_daily_update
        import json
        
        # Run the update
        result = run_daily_update()
        
        # Output results for GitHub Actions
        print(f'SUCCESS={result.success}')
        print(f'TOTAL_RECORDS={result.total_records}')
        print(f'NEW_RECORDS={result.new_records}')
        print(f'REMOVED_RECORDS={result.removed_records}')
        print(f'DUPLICATES_REMOVED={result.duplicates_removed}')
        print(f'INTEGRITY_SCORE={result.data_integrity_score:.3f}')
        
        # Set GitHub Actions outputs
        with open('$GITHUB_OUTPUT', 'a') as f:
            f.write(f'success={result.success}\n')
            f.write(f'total_records={result.total_records}\n')
            f.write(f'new_records={result.new_records}\n')
            f.write(f'removed_records={result.removed_records}\n')
            f.write(f'duplicates_removed={result.duplicates_removed}\n')
            f.write(f'integrity_score={result.data_integrity_score:.3f}\n')
        
        # Create summary
        if result.success:
            print('‚úÖ Daily update completed successfully!')
            print(f'üìä Total records: {result.total_records:,}')
            print(f'üÜï New records: {result.new_records}')
            print(f'üóëÔ∏è Removed records: {result.removed_records}')
            print(f'üîç Duplicates removed: {result.duplicates_removed}')
            print(f'üìà Data integrity: {result.data_integrity_score:.3f}')
        else:
            print('‚ùå Daily update failed!')
            for error in result.errors:
                print(f'   Error: {error}')
            exit(1)
        "
    
    - name: Check for changes and save new records
      if: steps.check_update.outputs.already_updated == 'false'
      id: changes
      run: |
        if git diff --quiet data/rx.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in rx.json"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in rx.json"
          echo ""
          echo "üÜï New Records Added:"
          echo "===================="
          
          # Save new records to a file for later use
          python -c "
        import json
        import subprocess
        
        # Get the diff and extract added lines
        diff_output = subprocess.run(['git', 'diff', 'data/rx.json'], capture_output=True, text=True).stdout
        
        # Parse added records from diff
        new_records = []
        for line in diff_output.split('\n'):
            if line.startswith('+') and not line.startswith('+++') and '{' in line:
                try:
                    # Extract JSON object from the line
                    json_str = line[1:].strip().rstrip(',')
                    record = json.loads(json_str)
                    new_records.append(record)
                except:
                    pass
        
        # Save to file for later use
        with open('/tmp/new_records.json', 'w') as f:
            json.dump(new_records, f)
        
        # Display new records
        if new_records:
            for i, record in enumerate(new_records, 1):
                print(f'{i}. {record.get(\"registration_number\", \"N/A\")} - {record.get(\"name\", \"N/A\")} ({record.get(\"category\", \"N/A\")})')
        else:
            print('No new records could be parsed from diff')
          "
        fi
    
    - name: Sync to Supabase
      if: steps.check_update.outputs.already_updated == 'false' && steps.changes.outputs.changes == 'true'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "‚òÅÔ∏è Syncing data to Supabase cloud database..."
        python scripts/sync_to_supabase.py
    
    - name: Commit and push changes
      if: steps.check_update.outputs.already_updated == 'false' && steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add data files (JSON only)
        git add data/rx.json
        
        # Create commit message with update details
        git commit -m "ü§ñ Daily data update - $(date '+%Y-%m-%d')

        üìä Update Summary:
        ‚Ä¢ Total records: ${{ steps.update.outputs.total_records }}
        ‚Ä¢ New records: ${{ steps.update.outputs.new_records }}
        ‚Ä¢ Removed records: ${{ steps.update.outputs.removed_records }}
        ‚Ä¢ Duplicates removed: ${{ steps.update.outputs.duplicates_removed }}
        ‚Ä¢ Data integrity: ${{ steps.update.outputs.integrity_score }}
        
        üîÑ Automated update using Total Records URL only
        üõ°Ô∏è Data validated and duplicates removed
        ‚è∞ Updated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        git push
    
    - name: Create update summary
      if: always()
      run: |
        echo "## üìä Daily TGPC Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.update.outputs.success == 'True' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Records:** ${{ steps.update.outputs.total_records }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New Records:** ${{ steps.update.outputs.new_records }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Removed Records:** ${{ steps.update.outputs.removed_records }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Duplicates Removed:** ${{ steps.update.outputs.duplicates_removed }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Integrity Score:** ${{ steps.update.outputs.integrity_score }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Daily update failed! Check the logs above for details."
        echo "The rx.json file was not updated due to validation failures or errors."