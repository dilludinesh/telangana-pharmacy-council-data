name: Rx Auto Sync

on:
  schedule:
    # Run daily (including weekends)
    # Randomized times between 11 AM - 3 PM IST (5:30 AM - 9:30 AM UTC)
    - cron: '45 5 * * 1'   # Monday 11:15 AM IST
    - cron: '20 7 * * 2'   # Tuesday 12:50 PM IST
    - cron: '55 8 * * 3'   # Wednesday 2:25 PM IST
    - cron: '10 6 * * 4'   # Thursday 11:40 AM IST
    - cron: '30 9 * * 5'   # Friday 3:00 PM IST
    - cron: '15 6 * * 6'   # Saturday 11:45 AM IST
    - cron: '40 8 * * 0'   # Sunday 2:10 PM IST
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install supabase
    
    - name: Create data directory
      run: |
        mkdir -p data/backups
    
    - name: Check if already updated today
      id: check_update
      run: |
        # Check if we already updated today by looking at recent commits
        TODAY=$(date -u +%Y-%m-%d)
        RECENT_COMMIT=$(git log --oneline --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --grep="ü§ñ Daily data update" | head -1)
        
        if [ -n "$RECENT_COMMIT" ]; then
          echo "already_updated=true" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Already updated today: $RECENT_COMMIT"
        else
          echo "already_updated=false" >> $GITHUB_OUTPUT
          echo "‚úÖ No update today yet, proceeding..."
        fi

    - name: Run daily update
      if: steps.check_update.outputs.already_updated == 'false'
      id: update
      run: |
        echo "üîÑ Starting daily TGPC data update during business hours..."
        echo "üîÑ Starting daily TGPC data update during business hours..."
        
        # Run the update via CLI
        python -m tgpc update
        
        # Note: The new CLI doesn't output GITHUB_OUTPUT variables yet. 
        # For now, we'll assume success if the command exits with 0.
        # We can enhance the CLI later to output these stats if needed.
        
        echo "success=True" >> $GITHUB_OUTPUT

    
    - name: Check for changes and save new records
      if: steps.check_update.outputs.already_updated == 'false'
      id: changes
      run: |
        if git diff --quiet data/rx.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in rx.json"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in rx.json"
          echo ""
          echo "üÜï New Records Added:"
          echo "===================="
          
          # Save new records to a file for later use
          python -c "
        import json
        import subprocess
        
        # Get the diff and extract added lines
        diff_output = subprocess.run(['git', 'diff', 'data/rx.json'], capture_output=True, text=True).stdout
        
        # Parse added records from diff
        new_records = []
        for line in diff_output.split('\n'):
            if line.startswith('+') and not line.startswith('+++') and '{' in line:
                try:
                    # Extract JSON object from the line
                    json_str = line[1:].strip().rstrip(',')
                    record = json.loads(json_str)
                    new_records.append(record)
                except:
                    pass
        
        # Save to file for later use
        with open('/tmp/new_records.json', 'w') as f:
            json.dump(new_records, f)
        
        # Display new records
        if new_records:
            for i, record in enumerate(new_records, 1):
                print(f'{i}. {record.get(\"registration_number\", \"N/A\")} - {record.get(\"name\", \"N/A\")} ({record.get(\"category\", \"N/A\")})')
        else:
            print('No new records could be parsed from diff')
          "
        fi
    
    - name: Sync to Supabase
      if: steps.check_update.outputs.already_updated == 'false' && steps.changes.outputs.changes == 'true'
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "‚òÅÔ∏è Syncing data to Supabase cloud database..."
        python -m tgpc sync
    
    - name: Commit and push changes
      if: steps.check_update.outputs.already_updated == 'false' && steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add data files (JSON only)
        git add data/rx.json
        
        # Create commit message with update details
        git commit -m "Rx Auto Update - $(date '+%Y-%m-%d')
        
        Total: ${{ steps.update.outputs.total_records }} | New: ${{ steps.update.outputs.new_records }} | Removed: ${{ steps.update.outputs.removed_records }} | Duplicates: ${{ steps.update.outputs.duplicates_removed }} | Integrity: ${{ steps.update.outputs.integrity_score }}"

        
        git push
    
    - name: Create update summary
      if: always()
      run: |
        # Parse details JSON
        NEW_DETAILS='${{ steps.update.outputs.new_details }}'
        REM_DETAILS='${{ steps.update.outputs.removed_details }}'
        MOD_DETAILS='${{ steps.update.outputs.modified_details }}'
        
        echo "### ‚ôªÔ∏è Rx Update" >> $GITHUB_STEP_SUMMARY
        echo "> **$(date '+%A, %d %B %Y')** ‚Ä¢ $(date '+%H:%M %Z')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Use python to parse JSON and output lists
        python -c "
        import json
        import os
        
        try:
            # Handle potential empty strings by defaulting to empty list JSON
            new_json = '$NEW_DETAILS' if '$NEW_DETAILS' else '[]'
            rem_json = '$REM_DETAILS' if '$REM_DETAILS' else '[]'
            mod_json = '$MOD_DETAILS' if '$MOD_DETAILS' else '[]'

            new_recs = json.loads(new_json) or []
            rem_recs = json.loads(rem_json) or []
            mod_recs = json.loads(mod_json) or []
            
            # New Additions
            print(f'### üÜï New Additions (+{len(new_recs)})')
            if new_recs:
                for r in new_recs:
                    print(f'- {r}')
            else:
                pass # print('No new records.')
            print('')
            
            # Modifications
            print(f'### ‚úèÔ∏è Modifications (+{len(mod_recs)})')
            if mod_recs:
                for r in mod_recs:
                    print(f'- {r}')
            print('')
                
            # Removals
            print(f'### üóëÔ∏è Removals (+{len(rem_recs)})')
            if rem_recs:
                for r in rem_recs:
                    print(f'- {r}')
            print('')
                
        except Exception as e:
            print(f'Error parsing details: {e}')
        " >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Daily update failed! Check the logs above for details."
        echo "The rx.json file was not updated due to validation failures or errors."