name: Data Fetch

on:
  schedule:
    # Run weekdays only during business hours (like a real office worker)
    # Randomized times between 11 AM - 3 PM UTC (peak business hours)
    - cron: '23 11 * * 1'  # Monday 11:23 AM UTC
    - cron: '47 12 * * 2'  # Tuesday 12:47 PM UTC
    - cron: '15 13 * * 3'  # Wednesday 1:15 PM UTC
    - cron: '38 14 * * 4'  # Thursday 2:38 PM UTC
    - cron: '52 11 * * 5'  # Friday 11:52 AM UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Create data directory
      run: |
        mkdir -p data/backups
    
    - name: Check if already updated today
      id: check_update
      run: |
        # Check if we already updated today by looking at recent commits
        TODAY=$(date -u +%Y-%m-%d)
        RECENT_COMMIT=$(git log --oneline --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --grep="ü§ñ Daily data update" | head -1)
        
        if [ -n "$RECENT_COMMIT" ]; then
          echo "already_updated=true" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Already updated today: $RECENT_COMMIT"
        else
          echo "already_updated=false" >> $GITHUB_OUTPUT
          echo "‚úÖ No update today yet, proceeding..."
        fi

    - name: Run daily update
      if: steps.check_update.outputs.already_updated == 'false'
      id: update
      run: |
        echo "üîÑ Starting daily TGPC data update during business hours..."
        python -c "
        from tgpc.automation.daily_updater import run_daily_update
        import json
        
        # Run the update
        result = run_daily_update()
        
        # Output results for GitHub Actions
        print(f'SUCCESS={result.success}')
        print(f'TOTAL_RECORDS={result.total_records}')
        print(f'NEW_RECORDS={result.new_records}')
        print(f'REMOVED_RECORDS={result.removed_records}')
        print(f'DUPLICATES_REMOVED={result.duplicates_removed}')
        print(f'INTEGRITY_SCORE={result.data_integrity_score:.3f}')
        
        # Set GitHub Actions outputs
        with open('$GITHUB_OUTPUT', 'a') as f:
            f.write(f'success={result.success}\n')
            f.write(f'total_records={result.total_records}\n')
            f.write(f'new_records={result.new_records}\n')
            f.write(f'removed_records={result.removed_records}\n')
            f.write(f'duplicates_removed={result.duplicates_removed}\n')
            f.write(f'integrity_score={result.data_integrity_score:.3f}\n')
        
        # Create summary
        if result.success:
            print('‚úÖ Daily update completed successfully!')
            print(f'üìä Total records: {result.total_records:,}')
            print(f'üÜï New records: {result.new_records}')
            print(f'üóëÔ∏è Removed records: {result.removed_records}')
            print(f'üîç Duplicates removed: {result.duplicates_removed}')
            print(f'üìà Data integrity: {result.data_integrity_score:.3f}')
        else:
            print('‚ùå Daily update failed!')
            for error in result.errors:
                print(f'   Error: {error}')
            exit(1)
        "
    
    - name: Check for changes
      if: steps.check_update.outputs.already_updated == 'false'
      id: changes
      run: |
        if git diff --quiet data/rx.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in rx.json"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in rx.json"
        fi
    
    - name: Commit and push changes
      if: steps.check_update.outputs.already_updated == 'false' && steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add only the data file (exclude backups from repo)
        git add data/rx.json
        
        # Create commit message with update details
        git commit -m "ü§ñ Daily data update - $(date '+%Y-%m-%d')

        üìä Update Summary:
        ‚Ä¢ Total records: ${{ steps.update.outputs.total_records }}
        ‚Ä¢ New records: ${{ steps.update.outputs.new_records }}
        ‚Ä¢ Removed records: ${{ steps.update.outputs.removed_records }}
        ‚Ä¢ Duplicates removed: ${{ steps.update.outputs.duplicates_removed }}
        ‚Ä¢ Data integrity: ${{ steps.update.outputs.integrity_score }}
        
        üîÑ Automated update using Total Records URL only
        üõ°Ô∏è Data validated and duplicates removed
        ‚è∞ Updated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        git push
    
    - name: Create update summary
      if: always()
      run: |
        echo "## üìä Daily TGPC Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.update.outputs.success == 'True' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Records:** ${{ steps.update.outputs.total_records }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New Records:** ${{ steps.update.outputs.new_records }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Removed Records:** ${{ steps.update.outputs.removed_records }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Duplicates Removed:** ${{ steps.update.outputs.duplicates_removed }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Integrity Score:** ${{ steps.update.outputs.integrity_score }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Data Source" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** https://www.pharmacycouncil.telangana.gov.in/pharmacy/srchpharmacisttotal" >> $GITHUB_STEP_SUMMARY
        echo "- **Method:** Single request to Total Records (server-friendly)" >> $GITHUB_STEP_SUMMARY
        echo "- **Fields:** serial_number, registration_number, name, father_name, category" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Daily update failed! Check the logs above for details."
        echo "The rx.json file was not updated due to validation failures or errors."